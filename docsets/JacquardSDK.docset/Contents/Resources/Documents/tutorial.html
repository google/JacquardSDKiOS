<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Tutorial  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset="utf-8">
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
    <script src="js/lunr.min.js" defer></script>
    <script src="js/typeahead.jquery.js" defer></script>
    <script src="js/jazzy.search.js" defer></script>
  </head>
  <body>


    <a title="Tutorial  Reference"></a>

    <header class="header">
      <p class="header-col header-col--primary">
        <a class="header-link" href="index.html">
          JacquardSDK 0.2.0 Docs
        </a>
         (100% documented)
      </p>
    
      <div class="header-col--secondary">
        <form role="search" action="search.json">
          <input type="text" placeholder="Search documentation" data-typeahead>
        </form>
      </div>
    
        <p class="header-col header-col--secondary">
          <a class="header-link" href="https://github.com/google/JacquardSDKiOS">
            <img class="header-icon" src="img/gh.png" alt="GitHub"/>
            View on GitHub
          </a>
        </p>
    
    </header>

    <p class="breadcrumbs">
      <a class="breadcrumb" href="index.html">JacquardSDK Reference</a>
      <img class="carat" src="img/carat.png" alt=""/>
      Tutorial  Reference
    </p>

    <div class="content-wrapper">
      <nav class="navigation">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Getting%20Started.html">Getting Started</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="tutorial.html">Tutorial</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="updating-firmware.html">Updating Firmware</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="integration.html">Integration</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="api-overview.html">API Overview</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="motion-capture.html">Motion Capture</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="releases.html">Releases</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="cloud-api-terms.html">Cloud API Terms</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Connecting%20to%20Tags.html">Connecting to Tags</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/JacquardManager.html">JacquardManager</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/JacquardManagerImplementation.html">JacquardManagerImplementation</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/ManagerScanningError.html">ManagerScanningError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/TagConnectionState.html">TagConnectionState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/TagConnectionError.html">TagConnectionError</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Tags.html">Tags</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/JacquardTag.html">JacquardTag</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/ConnectedTag.html">ConnectedTag</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/SubscribableTag.html">SubscribableTag</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/AdvertisedTag.html">AdvertisedTag</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/PreConnectedTag.html">PreConnectedTag</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Tags.html#/s:11JacquardSDK14ConnectableTagP">ConnectableTag</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/TouchMode.html">TouchMode</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/SetNameError.html">SetNameError</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Components%20and%20Gear.html">Components and Gear</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/Component.html">Component</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Components%20and%20Gear.html#/s:11JacquardSDK11ComponentIDa">ComponentID</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Components%20and%20Gear.html#/s:11JacquardSDK12GearMetadataa">GearMetadata</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Google_Jacquard_Protocol_Public_Sdk_GearMetadata.html">Google_Jacquard_Protocol_Public_Sdk_GearMetadata</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Google_Jacquard_Protocol_Public_Sdk_GearMetadata/Capability.html">– Capability</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Google_Jacquard_Protocol_Public_Sdk_GearMetadata/GearData.html">– GearData</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/ComponentInfo.html">ComponentInfo</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Commands.html">Commands</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/CommandRequest.html">CommandRequest</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/CommandResponseStatus.html">CommandResponseStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/JacquardCommandError.html">JacquardCommandError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/BatteryStatusCommand.html">BatteryStatusCommand</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/PlayLEDPatternCommand.html">PlayLEDPatternCommand</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/PlayLEDPatternCommand/Error.html">– Error</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/PlayLEDPatternCommand/LEDPatternType.html">– LEDPatternType</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/PlayLEDPatternCommand/LEDPatternPlayType.html">– LEDPatternPlayType</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/PlayLEDPatternCommand/Color.html">– Color</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/PlayLEDPatternCommand/Frame.html">– Frame</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/PlayHapticCommand.html">PlayHapticCommand</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/PlayHapticCommand/HapticPatternType.html">– HapticPatternType</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/PlayHapticCommand/Error.html">– Error</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/PlayHapticCommand/HapticFrame.html">– HapticFrame</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/DisconnectTagCommand.html">DisconnectTagCommand</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/ComponentInfoCommand.html">ComponentInfoCommand</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Notifications.html">Notifications</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/NotificationSubscription.html">NotificationSubscription</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/BatteryStatusNotificationSubscription.html">BatteryStatusNotificationSubscription</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/GestureNotificationSubscription.html">GestureNotificationSubscription</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/ContinuousTouchNotificationSubscription.html">ContinuousTouchNotificationSubscription</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Response%20Types.html">Response Types</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/BatteryStatus.html">BatteryStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/BatteryStatus/ChargingState.html">– ChargingState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/Gesture.html">Gesture</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/TouchData.html">TouchData</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Logging.html">Logging</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Logging.html#/s:11JacquardSDK09setGlobalA9SDKLoggeryyAA6Logger_pF">setGlobalJacquardSDKLogger(_:)</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/Logger.html">Logger</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/LogLevel.html">LogLevel</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/PrintLogger.html">PrintLogger</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other%20Classes.html">Other Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/IMUModuleImplementation.html">IMUModuleImplementation</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Classes/SDKConfig.html">SDKConfig</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other%20Enums.html">Other Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/APIError.html">APIError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other%20Enums.html#/s:11JacquardSDK25AccelerometerSamplingRateO">AccelerometerSamplingRate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other%20Enums.html#/s:11JacquardSDK11ConfigValueO">ConfigValue</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/DFUUpdateInfoStatus.html">DFUUpdateInfoStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other%20Enums.html#/s:11JacquardSDK18DataCollectionModeO">DataCollectionMode</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/DataCollectionStatus.html">DataCollectionStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/FirmwareUpdateError.html">FirmwareUpdateError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/FirmwareUpdateState.html">FirmwareUpdateState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other%20Enums.html#/s:11JacquardSDK21GyroscopeSamplingRateO">GyroscopeSamplingRate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/IMUSessionDownloadState.html">IMUSessionDownloadState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/IMUStreamingError.html">IMUStreamingError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/JacquardSDKVersion.html">JacquardSDKVersion</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/ModuleError.html">ModuleError</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/ModuleStatus.html">ModuleStatus</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Enums/TagConstants.html">TagConstants</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other%20Extensions.html">Other Extensions</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other%20Extensions.html#/c:@E@CBManagerState">CBManagerState</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Cancellable.html">Cancellable</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Extensions/Publisher.html">Publisher</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other%20Protocols.html">Other Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/FirmwareUpdateManager.html">FirmwareUpdateManager</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/IMUModule.html">IMUModule</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Protocols/NotificationParser.html">NotificationParser</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a class="nav-group-name-link" href="Other%20Structs.html">Other Structures</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/APIServer.html">APIServer</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other%20Structs.html#/s:11JacquardSDK21ActivateModuleCommandV">ActivateModuleCommand</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/ActivateModuleNotificationSubscription.html">ActivateModuleNotificationSubscription</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/DFUUpdateInfo.html">DFUUpdateInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other%20Structs.html#/s:11JacquardSDK23DeactivateModuleCommandV">DeactivateModuleCommand</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other%20Structs.html#/s:11JacquardSDK19DeleteModuleCommandV">DeleteModuleCommand</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/DeviceConfigElement.html">DeviceConfigElement</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/GetCustomConfigCommand.html">GetCustomConfigCommand</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/IMUSample.html">IMUSample</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/IMUSamplingRate.html">IMUSamplingRate</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/IMUSessionData.html">IMUSessionData</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/IMUSessionInfo.html">IMUSessionInfo</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Other%20Structs.html#/s:11JacquardSDK18ListModulesCommandV">ListModulesCommand</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Module.html">Module</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/SetCustomConfigCommand.html">SetCustomConfigCommand</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/Version.html">Version</a>
              </li>
              <li class="nav-group-task">
                <a class="nav-group-task-link" href="Structs/VidPidMid.html">VidPidMid</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">

        <section class="section">
          <div class="section-content top-matter">
            
            <h1 id='tutorial' class='heading'>Tutorial</h1>

<p>In this tutorial you will learn how to integrate the Jacquard SDK into
an iOS app, scan and connect to a tag, send commands and respond to
notifications.</p>

<p>You will need:</p>

<ol>
<li>Some Jacquard gear (see <a href="Getting%20Started.html#what-do-i-need-to-get-started">What do I need to get
started</a>).</li>
<li>An iOS device running iOS 13 or later (since the Jacquard SDK uses
Bluetooth to connect to your tag the simulator won&rsquo;t work).</li>
<li>An Apple developer account (either via the <a href="https://developer.apple.com/support/compare-memberships/">Apple Developer Program
or Sign in with your Apple
ID</a>.</li>
</ol>

<p>This tutorial will describe the following topics to build a basic app
that connects to a Jacquard tag and garment:</p>

<ol>
<li><a href="#1-prepare-your-jacquard-tag">Prepare your Jacquard Tag</a></li>
<li><a href="#2-create-a-new-xcode-project">Create a new Xcode project</a></li>
<li><a href="#3-configure-bluetooth-access-and-signing">Configure Bluetooth access and signing</a></li>
<li><a href="#4-integrate-jacquard-sdk-using-swift-package-manager">Integrate Jacquard SDK using Swift Package Manager</a></li>
<li><a href="#5-add-the-scanning-table-view">Add the scanning table view</a></li>
<li><a href="#6-displaying-the-advertised-tags-and-connecting-the-tableview-delegate">Displaying the advertised tags and connecting the TableView Delegate</a></li>
<li><a href="#7-displaying-already-connected-tags">Displaying already connected tags</a></li>
<li><a href="#8-adding-the-second-viewcontroller">Adding the second ViewController</a></li>
<li><a href="#9-connected-tags">Connected tags</a></li>
<li><a href="#10-sending-commands">Sending commands</a></li>
<li><a href="#11-observing-notifications">Observing Notifications</a></li>
<li><a href="#12-updating-firmwares">Updating Firmwares</a></li>
</ol>
<h2 id='1-prepare-your-jacquard-tag' class='heading'>1. Prepare your Jacquard Tag</h2>

<blockquote>
<p>If yo have just opened a new retail Jacquard product, your tag
probably needs a firmware update (and perhaps charging).</p>

<p>Perform the steps in the <a href="updating-firmware.html">Updating Firmware</a>
page before continuing.</p>
</blockquote>

<p>Hopefully you have updated your Tag and unlinked the Tag from the Jacquard App. </p>

<p>In addition to this, to ensure the smoothest path through this tutorial, go
to iOS Bluetooth settings, find the entry for your Jacquard Tag and
choose &ldquo;Forget this device&rdquo;.</p>

<p><img src="assets/tutorial-forget-ble.gif" alt="Animated GIF showing how to forget BLE
device"></p>
<h2 id='2-create-a-new-xcode-project' class='heading'>2. Create a new Xcode project</h2>

<p>In Xcode, create a new iOS <strong>App</strong> project, selecting UIKit and
Storyboard UI.</p>

<blockquote>
<p>File menu -&gt; New -&gt; Project</p>
</blockquote>

<p><img src="assets/tutorial-new-project.jpg" alt="Xcode new project dialog"></p>
<h2 id='3-configure-bluetooth-access-and-signing' class='heading'>3. Configure Bluetooth access and signing</h2>

<p>Since the Jacquard SDK uses Bluetooth to connect to your tag, it is
important to set up signing and entitlements correctly. This setup can
be done in the Target&rsquo;s &ldquo;Signing and Capabilities&rdquo; tab. The easiest
way to manage signing and capabilities (assuming you are correctly
logged into your developer account in Xcode&rsquo;s preferences) is to leave
&ldquo;Automatically manage signing&rdquo; checked, and then click the &ldquo;+
Capability&rdquo; button to find and add the Bluetooth capability.</p>

<p><img src="assets/tutorial-signing.jpg" alt="Xcode signing"></p>

<p>In the dialog that appears after clicking &ldquo;+&rdquo;, search for and select
&ldquo;Background Modes&rdquo;.</p>

<p><img src="assets/tutorial-capabilities-1.jpg" alt="Xcode capabilities dialog"></p>

<p>Out of the Background modes that appear, check &ldquo;Uses Bluetooth LE
accessories&rdquo;.</p>

<p><img src="assets/tutorial-capabilities-2.jpg" alt="Xcode background modes, select Bluetooth
LE"></p>

<p>You will also need to add the <code>NSBluetoothAlwaysUsageDescription</code> key
to <code>Info.plist</code>. Open <code>Info.plist</code> in the Project Navigator, and add a
description string with that key.</p>

<p><img src="assets/tutorial-info-plist.jpg" alt="Info.plist"></p>
<h2 id='4-integrate-jacquard-sdk-using-cocoapods' class='heading'>4. Integrate Jacquard SDK using Cocoapods</h2>

<p>The easiest way to integrate the Jacquard SDK is using Cocoapods dependency management. 
If you are not familiar with Cocoapods usage and installation, see <a href="integration.html">these instructions</a>.</p>

<ol>
<li><p>In the terminal, navigate to the directory containing your project&rsquo;s .xcodeproj file.</p></li>
<li><p>Run this command: <code>pod init</code></p>

<ul>
<li>A file named <em>Podfile</em> would be created in the directory.</li>
</ul></li>
<li><p>Open the Podfile and make the following three changes:</p>

<ul>
<li>Uncomment the <code>platform</code> directive and set to <code>13.0</code>:
<code>ruby
platform :ios, &#39;13.0&#39;
</code></li>
<li>Inside the <code>target</code>, add:
<code>ruby
pod &#39;JacquardSDK&#39;
</code></li>
<li><p>Your entire <code>Podfile</code> should now look something like this:</p>
<pre class="highlight ruby"><code><span class="n">platform</span> <span class="ss">:ios</span><span class="p">,</span> <span class="s1">'13.0'</span>

<span class="n">target</span> <span class="s1">'Jacquard Tutorial'</span> <span class="k">do</span>
  <span class="n">use_frameworks!</span>
  <span class="n">pod</span> <span class="s1">'JacquardSDK'</span>
<span class="k">end</span>
</code></pre></li>
</ul></li>
<li><p>Save the podfile, and in terminal run the following command: <code>pod install</code></p></li>
</ol>

<p>Xcode will download all the relevant files and integrate them with
your Xcode project. If your project is already open in xcode close it
and open the generated <code>.xcworkspace</code> file. (If you get an error
indicating that JacquardSDK could not be found, your CocoaPods cache
may be out of date - try <code>pod install --repo-update</code> instead.)</p>
<h2 id='5-add-the-scanning-table-view' class='heading'>5. Add the scanning table view</h2>

<p>The app you will make has two screens. The first is a tableview
listing any nearby advertising tags. The second is a screen with a few
simple labels and buttons which you will connect to Jacquard
functions.</p>

<p>First lets set up the Scanning view controller.</p>

<ol>
<li>Select <code>Main.storyboard</code> in the Project Navigator</li>
<li>Add a table view by

<ul>
<li>opening the Object Library (View menu -&gt; Show Library, or
Command-Shift-L)</li>
<li>find table view, and drag into the view controller.</li>
<li>Resize the table view to fill the view controller and add
appropriate constraints in the usual way.</li>
</ul></li>
<li>Your storyboard should look something like this: <img src="assets/tutorial-initial-storyboard.jpg" alt="Initial
storyboard"></li>
<li>The one last step to do before you start writing code is to connect
the table view to an outlet in your view controller.

<ul>
<li>Option-click <code>ViewController.swift</code> in the Project Navigator to
open it alongside the storyboard</li>
<li>Control-drag the table view into the ViewController class body
to create an outlet (call it tableView) <img src="assets/tutorial-outlet.jpg" alt="Creating an
outlet"></li>
</ul></li>
</ol>

<p>You&rsquo;re now ready to start coding!</p>

<p>First, <code>import</code> two libraries into ViewController.swift, <code>JacquardSDK</code>
and <code>Combine</code>.</p>

<blockquote>
<p>Keeping app state correct in the face of changing connection
conditions etc. can be challenging. To make this easier and safer,
the Jacquard SDK leans heavily on Apple&rsquo;s Combine* Functional
Reactive Programming framework. You can read more about this
approach in <a href="api-overview.html">API Overview</a>.</p>
</blockquote>

<p>With the <code>tableView</code> outlet and these two imports added, your
ViewController.swift should look like this:</p>

<p><img src="assets/tutorial-vc-1.jpg" alt="Outlet created"></p>

<blockquote>
<p>If you see an Xcode error that <code>JacquardSDK</code> does not exist, you may
need to build (Cmd-B) the project once for Xcode to notice the new
libraries that CocoaPods has added.</p>
</blockquote>

<p>The <code><a href="Protocols/JacquardManager.html">JacquardManager</a></code> protocol (and its concrete implementation,
<code><a href="Classes/JacquardManagerImplementation.html">JacquardManagerImplementation</a></code>) is the entry point to scanning for,
and connecting to, tags. Since for this demo you don&rsquo;t need to supply
a custom queue or any options, creating the manager is as simple as:<span class='footnote-ref' id="fnref2"><sup><a href="#fn2">1</a></sup></span></p>
<pre class="highlight swift"><code><span class="k">let</span> <span class="nv">jqManager</span><span class="p">:</span> <span class="kt">JacquardManager</span> <span class="o">=</span> <span class="kt">JacquardManagerImplementation</span><span class="p">(</span><span class="nv">publishQueue</span><span class="p">:</span> <span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[:])</span>
</code></pre>

<p>Add this as a property to the ViewController class.</p>

<p>Since this code will make use of a number of <code>Combine</code> publishers, you
need to store references to some <code>AnyCancellable</code> instances. Make that
easy with a simple extension, and create an array property in
<code>ViewController</code></p>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">AnyCancellable</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">addTo</span><span class="p">(</span><span class="n">_</span> <span class="nv">array</span><span class="p">:</span> <span class="k">inout</span> <span class="p">[</span><span class="kt">AnyCancellable</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">array</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">observations</span> <span class="o">=</span> <span class="p">[</span><span class="kt">AnyCancellable</span><span class="p">]</span> <span class="p">()</span>
  <span class="o">...</span>
<span class="p">}</span>
</code></pre>

<p>This tutorial app will start scanning as soon as possible. If you&rsquo;ve
used Apple&rsquo;s <code>CoreBluetooth</code> before, you will know that you need to
wait for Bluetooth to become available before that will work. The
Jacquard SDK exposes the state you need as a <code>Combine</code> publisher, so
you can start scanning as soon as the state becomes
<code>.poweredOn</code>.<span class='footnote-ref' id="fnref3"><sup><a href="#fn3">2</a></sup></span> Add this snippet to <code>viewDidLoad()</code>:</p>
<pre class="highlight swift"><code>    <span class="n">jqManager</span><span class="o">.</span><span class="n">centralState</span><span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">state</span> <span class="k">in</span>
      <span class="k">switch</span> <span class="n">state</span> <span class="p">{</span>
      <span class="k">case</span> <span class="o">.</span><span class="nv">poweredOn</span><span class="p">:</span>
        <span class="k">try!</span> <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">jqManager</span><span class="o">.</span><span class="nf">startScanning</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Scanning..."</span><span class="p">)</span>
      <span class="k">default</span><span class="p">:</span>
        <span class="k">break</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>
</code></pre>

<p>Once scanning has commenced, any tags that are discovered will be
available, again via a <code>Combine</code> publisher, from the <code>advertisingTag</code>
var. To check everything is working so far, just print out found
tags. Again, add this to <code>viewDidLoad()</code>:</p>
<pre class="highlight swift"><code>    <span class="n">jqManager</span><span class="o">.</span><span class="n">advertisingTags</span><span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="n">advertisedTag</span> <span class="k">in</span>
      <span class="nf">print</span><span class="p">(</span><span class="s">"Found advertising tag </span><span class="se">\(</span><span class="n">advertisedTag</span><span class="o">.</span><span class="n">displayName</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>
</code></pre>

<p>Before we build and run, check your <code>ViewController.swift</code> looks
something like this:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">UIKit</span>
<span class="kd">import</span> <span class="kt">Combine</span>
<span class="kd">import</span> <span class="kt">JacquardSDK</span>

<span class="kd">extension</span> <span class="kt">AnyCancellable</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">addTo</span><span class="p">(</span><span class="n">_</span> <span class="nv">array</span><span class="p">:</span> <span class="k">inout</span> <span class="p">[</span><span class="kt">AnyCancellable</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">array</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">observations</span> <span class="o">=</span> <span class="p">[</span><span class="kt">AnyCancellable</span><span class="p">]</span> <span class="p">()</span>

  <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="o">!</span>

  <span class="k">let</span> <span class="nv">jqManager</span><span class="p">:</span> <span class="kt">JacquardManager</span> <span class="o">=</span> <span class="kt">JacquardManagerImplementation</span><span class="p">()</span>

  <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>

    <span class="n">jqManager</span><span class="o">.</span><span class="n">advertisingTags</span><span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="n">advertisedTag</span> <span class="k">in</span>
      <span class="nf">print</span><span class="p">(</span><span class="s">"Found advertising tag </span><span class="se">\(</span><span class="n">advertisedTag</span><span class="o">.</span><span class="n">displayName</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>

    <span class="n">jqManager</span><span class="o">.</span><span class="n">centralState</span><span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">state</span> <span class="k">in</span>
      <span class="k">switch</span> <span class="n">state</span> <span class="p">{</span>
      <span class="k">case</span> <span class="o">.</span><span class="nv">poweredOn</span><span class="p">:</span>
        <span class="k">try!</span> <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">jqManager</span><span class="o">.</span><span class="nf">startScanning</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Scanning..."</span><span class="p">)</span>
      <span class="k">default</span><span class="p">:</span>
        <span class="k">break</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Now make sure your real iOS device is plugged in and selected in Xcode
as the run target. Click the Build and Run button, and your device
should show a system dialog saying &ldquo;Jacquard Tutorial&rdquo; Would like to
Use Bluetooth. Tap &ldquo;OK&rdquo;.</p>

<p>You should now see <code>Scanning...</code> in your Xcode output (you can ignore
any message about <code>centralManager:willRestoreState:</code> for now).</p>
<h3 id='put-the-jacquard-tag-into-advertising-mode' class='heading'>Put the Jacquard Tag into advertising mode</h3>

<p>Press and hold the button on your tag for 3 or 4 seconds (it can be a
little tricky to get right, you should hear and feel a click). The LED
on the tag will start pulsing, and you should see a log entry in Xcode
<code>Found advertising tag 01ZK</code> (your tag&rsquo;s identifier will be
different).</p>
<h2 id='6-displaying-the-advertised-tags-and-connecting-the-tableview-delegate' class='heading'>6. Displaying the advertised tags and connecting the TableView Delegate</h2>

<p>Here we are using a standard iOS approach to display the found tag in
a cell and respond to a tapped cell. Here is the full code -
copy/paste to replace the entirety of <code>ViewController.swift</code>:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">UIKit</span>
<span class="kd">import</span> <span class="kt">Combine</span>
<span class="kd">import</span> <span class="kt">JacquardSDK</span>

<span class="kd">extension</span> <span class="kt">AnyCancellable</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">addTo</span><span class="p">(</span><span class="n">_</span> <span class="nv">array</span><span class="p">:</span> <span class="k">inout</span> <span class="p">[</span><span class="kt">AnyCancellable</span><span class="p">])</span> <span class="p">{</span>
    <span class="n">array</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="k">self</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">struct</span> <span class="kt">TagCellModel</span><span class="p">:</span> <span class="kt">Hashable</span> <span class="p">{</span>
  <span class="k">var</span> <span class="nv">tag</span><span class="p">:</span> <span class="kt">ConnectableTag</span>
  <span class="kd">static</span> <span class="kd">func</span> <span class="o">==</span> <span class="p">(</span><span class="nv">lhs</span><span class="p">:</span> <span class="kt">TagCellModel</span><span class="p">,</span> <span class="nv">rhs</span><span class="p">:</span> <span class="kt">TagCellModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">lhs</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">identifier</span> <span class="o">==</span> <span class="n">rhs</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">identifier</span>
  <span class="p">}</span>
  <span class="kd">func</span> <span class="nf">hash</span><span class="p">(</span><span class="n">into</span> <span class="nv">hasher</span><span class="p">:</span> <span class="k">inout</span> <span class="kt">Hasher</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">tag</span><span class="o">.</span><span class="n">identifier</span><span class="o">.</span><span class="nf">hash</span><span class="p">(</span><span class="nv">into</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">hasher</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kd">class</span> <span class="kt">TagCell</span><span class="p">:</span> <span class="kt">UITableViewCell</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="k">let</span> <span class="nv">reuseIdentifier</span> <span class="o">=</span> <span class="s">"TagCell"</span>
  <span class="kd">func</span> <span class="nf">configure</span><span class="p">(</span><span class="n">_</span> <span class="nv">tagCellModel</span><span class="p">:</span> <span class="kt">TagCellModel</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">textLabel</span><span class="p">?</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">tagCellModel</span><span class="o">.</span><span class="n">tag</span><span class="o">.</span><span class="n">displayName</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

  <span class="kd">enum</span> <span class="kt">Section</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">advertisedTags</span>
  <span class="p">}</span>

  <span class="k">var</span> <span class="nv">observations</span> <span class="o">=</span> <span class="p">[</span><span class="kt">AnyCancellable</span><span class="p">]</span> <span class="p">()</span>
  <span class="k">var</span> <span class="nv">advertisedTags</span> <span class="o">=</span> <span class="p">[</span><span class="kt">AdvertisedTag</span><span class="p">]()</span>
  <span class="k">var</span> <span class="nv">diffableDataSource</span><span class="p">:</span> <span class="kt">UITableViewDiffableDataSource</span><span class="o">&lt;</span><span class="kt">Section</span><span class="p">,</span> <span class="kt">TagCellModel</span><span class="o">&gt;!</span>

  <span class="kd">@IBOutlet</span> <span class="k">weak</span> <span class="k">var</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="o">!</span>

  <span class="k">let</span> <span class="nv">jqManager</span><span class="p">:</span> <span class="kt">JacquardManager</span> <span class="o">=</span> <span class="kt">JacquardManagerImplementation</span><span class="p">(</span><span class="nv">publishQueue</span><span class="p">:</span> <span class="o">.</span><span class="n">main</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[:])</span>

  <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>

    <span class="n">tableView</span><span class="o">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="k">self</span>
    <span class="n">tableView</span><span class="o">.</span><span class="nf">register</span><span class="p">(</span><span class="kt">TagCell</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">forCellReuseIdentifier</span><span class="p">:</span> <span class="kt">TagCell</span><span class="o">.</span><span class="n">reuseIdentifier</span><span class="p">)</span>

    <span class="n">diffableDataSource</span> <span class="o">=</span> <span class="kt">UITableViewDiffableDataSource</span><span class="p">(</span><span class="nv">tableView</span><span class="p">:</span> <span class="n">tableView</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">tableView</span><span class="p">,</span> <span class="n">indexPath</span><span class="p">,</span> <span class="n">tagModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UITableViewCell</span><span class="p">?</span> <span class="k">in</span>
      <span class="k">let</span> <span class="nv">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="nf">dequeueReusableCell</span><span class="p">(</span><span class="nv">withIdentifier</span><span class="p">:</span> <span class="kt">TagCell</span><span class="o">.</span><span class="n">reuseIdentifier</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span> <span class="k">as!</span> <span class="kt">TagCell</span>
      <span class="n">cell</span><span class="o">.</span><span class="nf">configure</span><span class="p">(</span><span class="n">tagModel</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">cell</span>
    <span class="p">}</span>
    <span class="n">tableView</span><span class="o">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="n">diffableDataSource</span>

    <span class="n">jqManager</span><span class="o">.</span><span class="n">advertisingTags</span><span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">advertisedTag</span> <span class="k">in</span>
      <span class="nf">print</span><span class="p">(</span><span class="s">"Found advertising tag </span><span class="se">\(</span><span class="n">advertisedTag</span><span class="o">.</span><span class="n">displayName</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>

      <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
      <span class="k">self</span><span class="o">.</span><span class="n">advertisedTags</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">advertisedTag</span><span class="p">)</span>
      <span class="k">self</span><span class="o">.</span><span class="nf">updateDataSource</span><span class="p">()</span>
    <span class="p">}</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>

    <span class="n">jqManager</span><span class="o">.</span><span class="n">centralState</span><span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">state</span> <span class="k">in</span>
      <span class="k">switch</span> <span class="n">state</span> <span class="p">{</span>
      <span class="k">case</span> <span class="o">.</span><span class="nv">poweredOn</span><span class="p">:</span>
        <span class="k">try!</span> <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">jqManager</span><span class="o">.</span><span class="nf">startScanning</span><span class="p">()</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Scanning..."</span><span class="p">)</span>
      <span class="k">default</span><span class="p">:</span>
        <span class="k">break</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">func</span> <span class="nf">updateDataSource</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">models</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">advertisedTags</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="kt">TagCellModel</span><span class="p">(</span><span class="nv">tag</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">snapshot</span> <span class="o">=</span> <span class="kt">NSDiffableDataSourceSnapshot</span><span class="o">&lt;</span><span class="kt">Section</span><span class="p">,</span> <span class="kt">TagCellModel</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="n">snapshot</span><span class="o">.</span><span class="nf">appendSections</span><span class="p">([</span><span class="o">.</span><span class="n">advertisedTags</span><span class="p">])</span>
    <span class="n">snapshot</span><span class="o">.</span><span class="nf">appendItems</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="nv">toSection</span><span class="p">:</span> <span class="o">.</span><span class="n">advertisedTags</span><span class="p">)</span>
    <span class="k">self</span><span class="o">.</span><span class="n">diffableDataSource</span><span class="o">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">extension</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UITableViewDelegate</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">jqManager</span><span class="o">.</span><span class="nf">stopScanning</span><span class="p">()</span>

    <span class="c1">// Here we will connect to the tag.</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>You should be able to build and run and see advertising tags in the
table view (you will need to press and hold the tag button again -
Jacquard tags stop advertising after 60 seconds).</p>
<h2 id='7-displaying-already-connected-tags' class='heading'>7. Displaying already connected tags</h2>

<p>When the tag is paired and connected to iOS, it will no longer
advertise. This means we need to use a different mechanism to obtain a
connection object for an already-connected tag. The view controller
will be updated to display those already-connected tags as well as
advertising tags.</p>

<p>Add an instance variable to the view controller to keep a consistent
view of pre-connected tags, and also add a new entry to the <code>Section</code>
enum for the table view:</p>
<pre class="highlight swift"><code><span class="kd">class</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

  <span class="kd">enum</span> <span class="kt">Section</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">advertisedTags</span>
    <span class="k">case</span> <span class="n">preConnectedTags</span>
  <span class="p">}</span>

  <span class="k">var</span> <span class="nv">preConnectedTags</span> <span class="o">=</span> <span class="p">[</span><span class="kt">PreConnectedTag</span><span class="p">]()</span>

  <span class="c1">//...</span>
<span class="p">}</span>
</code></pre>

<p>Like most CoreBluetooth functions, we can&rsquo;t read the list of connected
tags until the <code>CBCentralState</code> is <code>.poweredOn</code>, so in <code>viewDidLoad</code>
we will update the central state observation to also update our list
of tags:</p>
<pre class="highlight swift"><code><span class="n">jqManager</span><span class="o">.</span><span class="n">centralState</span><span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">state</span> <span class="k">in</span>
  <span class="k">switch</span> <span class="n">state</span> <span class="p">{</span>
  <span class="k">case</span> <span class="o">.</span><span class="nv">poweredOn</span><span class="p">:</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="k">self</span><span class="o">.</span><span class="n">advertisedTags</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="n">advertisedTag</span><span class="p">)</span>
    <span class="c1">//</span>
    <span class="c1">// *** The following line is added</span>
    <span class="c1">//</span>
    <span class="k">self</span><span class="o">.</span><span class="n">preConnectedTags</span> <span class="o">=</span> <span class="k">self</span><span class="o">.</span><span class="n">jqManager</span><span class="o">.</span><span class="nf">preConnectedTags</span><span class="p">()</span>
    <span class="c1">// ***</span>
    <span class="k">self</span><span class="o">.</span><span class="nf">updateDataSource</span><span class="p">()</span>
    <span class="k">try!</span> <span class="k">self</span><span class="o">.</span><span class="n">jqManager</span><span class="o">.</span><span class="nf">startScanning</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Scanning..."</span><span class="p">)</span>
  <span class="k">default</span><span class="p">:</span>
    <span class="k">break</span>
  <span class="p">}</span>
<span class="p">}</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>
</code></pre>

<blockquote>
<p>Note that since reading pre-connected tags from CoreBluetooth is
synchronous only, this method won&rsquo;t automatically update if a nearby
tag wakes up and connects while the view is on screen. In a real app
you may wish to persist a list of known tag UUIDs - the <a href="https://github.com/google/JacquardSDKiOS">sample
app</a> is an example of
doing that.</p>
</blockquote>

<p>Finally the <code>updateDataSource()</code> method needs to be updated to also
display these tags in a new section:</p>
<pre class="highlight swift"><code>  <span class="kd">func</span> <span class="nf">updateDataSource</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">advertisedModels</span> <span class="o">=</span> <span class="n">advertisedTags</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="kt">TagCellModel</span><span class="p">(</span><span class="nv">tag</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">let</span> <span class="nv">preConnectedModels</span> <span class="o">=</span> <span class="n">preConnectedTags</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="kt">TagCellModel</span><span class="p">(</span><span class="nv">tag</span><span class="p">:</span> <span class="nv">$0</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">var</span> <span class="nv">snapshot</span> <span class="o">=</span> <span class="kt">NSDiffableDataSourceSnapshot</span><span class="o">&lt;</span><span class="kt">Section</span><span class="p">,</span> <span class="kt">TagCellModel</span><span class="o">&gt;</span><span class="p">()</span>
    <span class="n">snapshot</span><span class="o">.</span><span class="nf">appendSections</span><span class="p">([</span><span class="o">.</span><span class="n">advertisedTags</span><span class="p">,</span> <span class="o">.</span><span class="n">preConnectedTags</span><span class="p">])</span>
    <span class="n">snapshot</span><span class="o">.</span><span class="nf">appendItems</span><span class="p">(</span><span class="n">advertisedModels</span><span class="p">,</span> <span class="nv">toSection</span><span class="p">:</span> <span class="o">.</span><span class="n">advertisedTags</span><span class="p">)</span>
    <span class="n">snapshot</span><span class="o">.</span><span class="nf">appendItems</span><span class="p">(</span><span class="n">preConnectedModels</span><span class="p">)</span>
    <span class="k">self</span><span class="o">.</span><span class="n">diffableDataSource</span><span class="o">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre>
<h2 id='8-adding-the-second-viewcontroller' class='heading'>8. Adding the second ViewController</h2>

<p>First create an empty View Controller class.</p>

<ol>
<li>Right-click on the <code>Jacquard Tutorial</code> folder icon in the Project
Navigator and select <code>New File...</code></li>
<li>Select Cocoa Touch Class <img src="assets/tutorial-new-file.jpg" alt="New file"></li>
<li>Click Next</li>
<li>Name the class <code>ConnectedViewController</code>, subclass of
<code>UIViewController</code>. <img src="assets/tutorial-connected-viewcontroller.jpg" alt="New
viewcontroller"></li>
<li>Click Next and save</li>
</ol>

<p>The storyboard needs the second view controller, but first we need to
embed our first view controller in a <code>NavigationController</code>.</p>

<ol>
<li>Return to <code>Main.storyboard</code></li>
<li>Select &ldquo;View Controller&rdquo;</li>
<li>Choose the menu option Editor &gt; Embed in &gt; Navigation Controller
<img src="assets/tutorial-embed.jpg" alt="Embed in navigation controller"></li>
</ol>

<p>Now you can add the second view controller.</p>

<ol>
<li>Using the Object library again (Command-Shift-L), drag a blank
<code>UIViewController</code> onto a blank area in the canvas.</li>
<li>Select the new view controller, and in the Inspector, set the class
to the <code>ConnectedViewController</code> class created above.</li>
<li>Also set the &ldquo;Storyboard ID&rdquo; to <code>connectedViewController</code></li>
</ol>

<p>Your Storyboard should now look something like this:</p>

<p><img src="assets/tutorial-storyboard-secondvc.jpg" alt="Storyboard with extra view
controller"></p>

<p>We will add some real UI later, but first lets connect the tag and the
view controller together.</p>
<h2 id='9-connected-tags' class='heading'>9. Connected tags</h2>

<p>Connecting to tags is an important step that is fully documented in
<a href="Connecting%20to%20Tags.html">Connecting to Tags</a>.</p>

<blockquote>
<p>Sufficient for this tutorial, the <code>connect()</code> methods on
<code><a href="Protocols/JacquardManager.html">JacquardManager</a></code> return a Combine Publisher which publish a
sequence of <code><a href="Enums/TagConnectionState.html">TagConnectionState</a></code> states, including a number of
pre-connection states, <code>.connected()</code> and
<code>.disconnected(Error?)</code>.</p>

<p>The disconnected state should happen extremely rarely - in normal
disconnection scenarios (for example the tag goes out of Bluetooth
range), the <code><a href="Protocols/JacquardManager.html">JacquardManager</a></code> instance will automatically attempt to
reconnect, and will (eventually) publish a further <code>.connected()</code>
state. In cases where the tag is near the limit of Bluetooth range,
it is common for a lot of <code>.connected()</code> states to be published in
relatively quick succession.</p>

<p>Relying on the Combine Publishers as shown in this tutorial and the
<a href="https://github.com/google/JacquardSDKiOS">sample app</a> will ensure
your app is always using the most recent connected tag instance -
resist the temptation to store a <code><a href="Protocols/ConnectedTag.html">ConnectedTag</a></code> in an instance
variable.</p>

<p>One case that is not handled for you is when Bluetooth is turned off
(and possibly back on). You should observe the other states of
<code>jqManager.centralState</code> to respond to this.</p>
</blockquote>
<h3 id='using-a-connected-tag' class='heading'>Using a connected tag</h3>

<p>First, let&rsquo;s update <code>ConnectedViewController</code> to store the
relevant connection publisher, and set the title by observing the
tag&rsquo;s name. As above, the expected pattern is to interact
with <code><a href="Protocols/ConnectedTag.html">ConnectedTag</a></code> instances always from the connection publisher (to
ensure you are never using a stale/disconnected instance).</p>

<p>Replace the entire contents of <code>ConnectedViewController.swift</code> with
the following code block:</p>
<pre class="highlight swift"><code><span class="kd">import</span> <span class="kt">UIKit</span>
<span class="kd">import</span> <span class="kt">JacquardSDK</span>
<span class="kd">import</span> <span class="kt">Combine</span>

<span class="kd">class</span> <span class="kt">ConnectedViewController</span><span class="p">:</span> <span class="kt">UIViewController</span> <span class="p">{</span>

  <span class="k">var</span> <span class="nv">tagConnectionPublisher</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">TagConnectionState</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">?</span>
  <span class="k">var</span> <span class="nv">observations</span> <span class="o">=</span> <span class="p">[</span><span class="kt">AnyCancellable</span><span class="p">]</span> <span class="p">()</span>

  <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>

    <span class="n">tagConnectionPublisher</span><span class="p">?</span><span class="o">.</span><span class="n">compactMap</span> <span class="p">{</span> <span class="n">connectionState</span> <span class="o">-&gt;</span> <span class="kt">ConnectedTag</span><span class="p">?</span> <span class="k">in</span>
      <span class="k">switch</span> <span class="n">connectionState</span> <span class="p">{</span>
      <span class="k">case</span> <span class="o">.</span><span class="nf">connected</span><span class="p">(</span><span class="k">let</span> <span class="nv">tag</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tag</span>
      <span class="k">default</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Not connected, in connection state: </span><span class="se">\(</span><span class="n">connectionState</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">nil</span>
      <span class="p">}</span>
    <span class="p">}</span><span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span>
      <span class="nv">$0</span><span class="o">.</span><span class="n">namePublisher</span>
    <span class="p">}</span><span class="o">.</span><span class="nf">sink</span><span class="p">(</span><span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
      <span class="nf">print</span><span class="p">(</span><span class="s">"Unrecoverable connection error: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">},</span> <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">name</span> <span class="k">in</span>
      <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">name</span>
    <span class="p">})</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>This is quite a long chain of Combine operators, and it is common to
want simple access to a connected tag. We will look at tidying this up
later.</p>
<h3 id='connecting-to-the-tag' class='heading'>Connecting to the tag</h3>

<p>Returning to the original <code>ViewController.swift</code> file, we will update
<code>tableView(_, didSelectRowAt:)</code> to connect to the selected tag and
present the second view controller.</p>
<pre class="highlight swift"><code><span class="kd">extension</span> <span class="kt">ViewController</span><span class="p">:</span> <span class="kt">UITableViewDelegate</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="n">_</span> <span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">didSelectRowAt</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">IndexPath</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">jqManager</span><span class="o">.</span><span class="nf">stopScanning</span><span class="p">()</span>

    <span class="k">guard</span> <span class="k">let</span> <span class="nv">model</span> <span class="o">=</span> <span class="n">diffableDataSource</span><span class="o">.</span><span class="nf">itemIdentifier</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">guard</span> <span class="k">let</span> <span class="nv">nextVC</span> <span class="o">=</span> <span class="n">storyboard</span><span class="p">?</span><span class="o">.</span><span class="nf">instantiateViewController</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="s">"connectedViewController"</span><span class="p">)</span>
            <span class="k">as?</span> <span class="kt">ConnectedViewController</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nf">preconditionFailure</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="n">nextVC</span><span class="o">.</span><span class="n">tagConnectionPublisher</span> <span class="o">=</span> <span class="n">jqManager</span><span class="o">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
    <span class="n">navigationController</span><span class="p">?</span><span class="o">.</span><span class="nf">pushViewController</span><span class="p">(</span><span class="n">nextVC</span><span class="p">,</span> <span class="nv">animated</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>

<p>Congratulations, your app will now show an advertising tag, connect to
it, and set the view controller title. Try it now (and don&rsquo;t forget to
press the tag&rsquo;s button for four seconds to restart pairing mode).</p>

<p><img src="assets/tutorial-firstlaunch.gif" alt="First launch demo"></p>
<h2 id='10-sending-commands' class='heading'>10. Sending commands</h2>

<p>Now we&rsquo;ll explore sending commands to the tag, in this case
<code><a href="Structs/PlayLEDPatternCommand.html">PlayLEDPatternCommand</a></code> (commands are documented in the
<a href="Commands.html">Commands</a> documentation).</p>

<p>But first, lets tidy up that long Combine operator chain by creating a
simpler publisher. Normally we&rsquo;re only interested in getting access to
the latest <code><a href="Protocols/ConnectedTag.html">ConnectedTag</a></code>. Sometimes we want to keep observing the
latest (such as above where any name updates will continue to update
the View Controller title even after reconnections). Often we want
just the current or next connected tag for a one-time use (such as to
play an LED pattern). We can use Combine operators to easily achieve
both.</p>

<p>When the <code>tagConnectionPublisher</code> instance variable is set in
<code>ConnectedViewController.swift</code>, we will also create the derived
publishers we want. Switch to <code>ConnectedViewController.swift</code>, add
a <code>tagPublisher</code> property and set it by adding a <code>didSet</code> observer:</p>
<pre class="highlight swift"><code>  <span class="k">var</span> <span class="nv">tagPublisher</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">ConnectedTag</span><span class="p">,</span> <span class="kt">Never</span><span class="o">&gt;</span><span class="p">?</span>
  <span class="k">var</span> <span class="nv">tagConnectionPublisher</span><span class="p">:</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">TagConnectionState</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">didSet</span> <span class="p">{</span>
      <span class="n">tagPublisher</span> <span class="o">=</span> <span class="n">tagConnectionPublisher</span><span class="p">?</span>
        <span class="o">.</span><span class="k">catch</span> <span class="p">{</span>
          <span class="c1">// Connection failures will be handled elsewhere.</span>
          <span class="kt">Just</span><span class="o">&lt;</span><span class="kt">TagConnectionState</span><span class="o">&gt;</span><span class="p">(</span><span class="kt">TagConnectionState</span><span class="o">.</span><span class="nf">disconnected</span><span class="p">(</span><span class="nv">$0</span><span class="p">))</span>
        <span class="p">}</span><span class="o">.</span><span class="n">compactMap</span> <span class="p">{</span> <span class="n">connectionState</span> <span class="o">-&gt;</span> <span class="kt">ConnectedTag</span><span class="p">?</span> <span class="k">in</span>
          <span class="k">switch</span> <span class="n">connectionState</span> <span class="p">{</span>
          <span class="k">case</span> <span class="o">.</span><span class="nf">connected</span><span class="p">(</span><span class="k">let</span> <span class="nv">tag</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tag</span>
          <span class="k">default</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="s">"Not connected, in connection state: </span><span class="se">\(</span><span class="n">connectionState</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">nil</span>
          <span class="p">}</span>
        <span class="p">}</span><span class="o">.</span><span class="nf">eraseToAnyPublisher</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre>

<p>For any functionality where knowing the precise state of connection is
important (for example displaying connection status, or enabling UI),
the <code>tagConnectionPublisher</code> can be used. For most common cases the
simpler <code>tagPublisher</code> can be used. Let&rsquo;s change our title update code
to use this new publisher.</p>
<pre class="highlight swift"><code>  <span class="k">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">viewDidLoad</span><span class="p">()</span>

    <span class="n">tagPublisher</span><span class="p">?</span>
      <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="nv">$0</span><span class="o">.</span><span class="n">namePublisher</span> <span class="p">}</span>
      <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">name</span> <span class="k">in</span> <span class="k">self</span><span class="p">?</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">name</span>  <span class="p">}</span>
      <span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre>

<p>Much tidier. Now lets add a button to send an LED command to the tag
(some Jacquard garments also have LEDs which can be addressed
independently, but here we will use the tag&rsquo;s built-in LED).</p>
<h3 id='adding-the-button' class='heading'>Adding the button</h3>

<ol>
<li>Edit <code>Main.storyboard</code> again</li>
<li>Drag a UIButton from the Object Library onto &ldquo;Connected View Controller&rdquo;</li>
<li>Set the button&rsquo;s title to &ldquo;Play LED Pattern&rdquo;</li>
<li>Apply constraints to locate the button wherever you wish</li>
<li>Option-click <code>ConnectedViewController.swift</code> in the project
navigator to open it alongside the storyboard, and control-drag
from the button to create a target/action method <img src="assets/tutorial-play-led-action.jpg" alt="Connecting
button"></li>
<li>Name the method <code>playLEDTap</code></li>
</ol>

<p>Sending a command to a tag has three phases, constructing the command
request instance, sending it to the tag, and finally waiting for the
response (or error).</p>

<p>Like all other asynchronous tasks in the Jacquard SDK, sending
commands creates a Combine publisher. Some commands publish a return
value (like <code><a href="Structs/BatteryStatusCommand.html">BatteryStatusCommand</a></code>), others like <code>PlayLEDCommand</code>
publish <code>Void</code> for success, or may fail with an error. Sending the
command is achieved using the <code>enqueue(_:retries:)</code> method on
<code><a href="Protocols/ConnectedTag.html">ConnectedTag</a></code>.</p>

<p>Some commands, as in this case, require a <code><a href="Protocols/Component.html">Component</a></code> argument. They
are documented more thoroughly in the <a href="Components%20and%20Gear.html">Components</a>
documentation, but in essence a <code><a href="Protocols/Component.html">Component</a></code> represents a currently
connected piece of Jacquard gear. The tag has a built-in <code><a href="Protocols/Component.html">Component</a></code>
(which is always available) and Jacquard gear (like a jacket or
backpack) may be connected to the tag. Each component has different
capabilities (which you can introspect using the <code>capabilities</code>
method), but we know that the tag&rsquo;s built-in component always has an
LED.</p>

<p>Your <code>playLEDTap</code> method should look something like:</p>
<pre class="highlight swift"><code>  <span class="kd">@IBAction</span> <span class="kd">func</span> <span class="nf">playLEDTap</span><span class="p">(</span><span class="n">_</span> <span class="nv">sender</span><span class="p">:</span> <span class="kt">Any</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">blue</span> <span class="o">=</span> <span class="kt">PlayLEDPatternCommand</span><span class="o">.</span><span class="kt">Color</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">green</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">blue</span><span class="p">:</span> <span class="mi">255</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">red</span> <span class="o">=</span> <span class="kt">PlayLEDPatternCommand</span><span class="o">.</span><span class="kt">Color</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span> <span class="nv">green</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">blue</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">yellow</span> <span class="o">=</span> <span class="kt">PlayLEDPatternCommand</span><span class="o">.</span><span class="kt">Color</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span> <span class="nv">green</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span> <span class="nv">blue</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">green</span> <span class="o">=</span> <span class="kt">PlayLEDPatternCommand</span><span class="o">.</span><span class="kt">Color</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">green</span><span class="p">:</span> <span class="mi">255</span><span class="p">,</span> <span class="nv">blue</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">let</span> <span class="nv">off</span> <span class="o">=</span> <span class="kt">PlayLEDPatternCommand</span><span class="o">.</span><span class="kt">Color</span><span class="p">(</span><span class="nv">red</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">green</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">blue</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">let</span> <span class="nv">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">blue</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">yellow</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">off</span><span class="p">]</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span>
      <span class="kt">PlayLEDPatternCommand</span><span class="o">.</span><span class="kt">Frame</span><span class="p">(</span><span class="nv">color</span><span class="p">:</span> <span class="nv">$0</span><span class="p">,</span> <span class="nv">durationMs</span><span class="p">:</span> <span class="mi">250</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">tagPublisher</span><span class="p">?</span>
      <span class="o">.</span><span class="nf">prefix</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="o">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">tag</span> <span class="o">-&gt;</span> <span class="kt">AnyPublisher</span><span class="o">&lt;</span><span class="kt">Void</span><span class="p">,</span> <span class="kt">Error</span><span class="o">&gt;</span> <span class="k">in</span>
        <span class="k">let</span> <span class="nv">commandRequest</span> <span class="o">=</span> <span class="k">try!</span> <span class="kt">PlayLEDPatternCommand</span><span class="p">(</span>
          <span class="nv">frames</span><span class="p">:</span> <span class="n">frames</span><span class="p">,</span>
          <span class="nv">durationMs</span><span class="p">:</span> <span class="mi">6000</span><span class="p">,</span>
          <span class="nv">component</span><span class="p">:</span> <span class="n">tag</span><span class="o">.</span><span class="n">tagComponent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tag</span><span class="o">.</span><span class="nf">enqueue</span><span class="p">(</span><span class="n">commandRequest</span><span class="p">)</span>
      <span class="p">}</span><span class="o">.</span><span class="nf">sink</span><span class="p">(</span><span class="nv">receiveCompletion</span><span class="p">:</span> <span class="p">{</span> <span class="n">error</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Failed to play LED pattern: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
      <span class="p">},</span> <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Played LED pattern successfully"</span><span class="p">)</span>
      <span class="p">})</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre>

<p>The <code>.prefix(1)</code> operator is important here. It means take the first
connected tag and then stop. If we didn&rsquo;t apply that here, then if the
tag disconnected and reconnected, the led pattern would be played
again!</p>

<p>Try building and running your app - you should be able to make the LED
play this pattern.</p>
<h2 id='11-observing-notifications' class='heading'>11. Observing Notifications</h2>

<p>Commands are initiated by the app and sent to the tag (possibly with a
response). Notifications on the other hand originate from the tag at
any time. As you may have guessed, notification subscriptions come in
the form of a Combine publisher.</p>

<blockquote>
<p>Instead of using the <code><a href="Protocols/ConnectedTag.html">ConnectedTag</a></code> instance directly, there is a
small extra step to get a <code><a href="Protocols/SubscribableTag.html">SubscribableTag</a></code>. This is an important
part of how State Restoration is handled, which is explained in the
<code><a href="Protocols/ConnectedTag.html">ConnectedTag</a></code> documentation.</p>
</blockquote>

<p>First add a method to <code>ConnectedViewContrller</code> which will do something
useful with a gesture notification. In this case we will define
&ldquo;useful&rdquo; to mean printing out to the console:</p>
<pre class="highlight swift"><code>  <span class="kd">func</span> <span class="nf">createSubscriptions</span><span class="p">(</span><span class="n">_</span> <span class="nv">tag</span><span class="p">:</span> <span class="kt">SubscribableTag</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">gestureNotificationRequest</span> <span class="o">=</span> <span class="kt">GestureNotificationSubscription</span><span class="p">()</span>
    <span class="n">tag</span><span class="o">.</span><span class="nf">subscribe</span><span class="p">(</span><span class="n">gestureNotificationRequest</span><span class="p">)</span>
      <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="n">gesture</span> <span class="k">in</span>
        <span class="nf">print</span><span class="p">(</span><span class="s">"Observed gesture: </span><span class="se">\(</span><span class="n">gesture</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
      <span class="p">}</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>
  <span class="p">}</span>
</code></pre>

<p>Now call this method with a <code><a href="Protocols/SubscribableTag.html">SubscribableTag</a></code> instance whenever the
tag connects or reconnects. Place this code in the <code>viewDidLoad()</code>
method of <code>ConnectedViewController</code>:</p>
<pre class="highlight swift"><code>    <span class="n">tagPublisher</span><span class="p">?</span>
      <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="p">[</span><span class="k">weak</span> <span class="k">self</span><span class="p">]</span> <span class="n">tag</span> <span class="k">in</span>
        <span class="k">guard</span> <span class="k">let</span> <span class="nv">self</span> <span class="o">=</span> <span class="k">self</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
        <span class="n">tag</span><span class="o">.</span><span class="nf">registerSubscriptions</span><span class="p">(</span><span class="k">self</span><span class="o">.</span><span class="n">createSubscriptions</span><span class="p">)</span>
      <span class="p">}</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observations</span><span class="p">)</span>
</code></pre>

<p>This is the final build and run for this tutorial. Once you have
connected to the tag again, insert the tag into your Jacquard gear and
perform a brush, double tap or other gesture and you will see the
gesture logged into the Xcode console.</p>

<p>You have now successfully integrated the Jacquard SDK and learned how
to connect, send commands and observe notifications. There&rsquo;s more to
the SDK which you can see demonstrated in the <a href="https://github.com/google/JacquardSDKiOS">sample
app</a> and read about in the
SDK documentation (see the table of contents on the left side of this
page).</p>
<h2 id='12-updating-firmwares' class='heading'>12. Updating Firmwares</h2>

<p>Before using any Jacquard SDK core api, it is always recommended to ensure that you have the latest
available firmware. After your tag is paired, next ideal step should be to check for firmware update
by calling Jacquard SDK firmware api&rsquo;s which are backed up by Jacquard cloud.
Updating firmware is a 3 step process -</p>
<h4 id='1-check-if-update-available' class='heading'>1. Check if update available</h4>

<p>This step would need internet connectivity as it calls Jacquard cloud api to see if any firmware
updates are available. If updates are available for your current firmware, sdk will start downloading firmware
binary implicitly. Updates can be of 2 types.</p>

<ol>
<li>Mandatory - Firmware update is required.</li>
<li>Optional - Firmware update is optional and can be skipped.</li>
<li>None - If there is no updates available.</li>
</ol>
<h4 id='2-apply-updates' class='heading'>2. Apply updates</h4>

<p>Jacquard sdk will transfer downloaded firmware binary to the tag using bluetooth connection.
This step might take a while depending on the size of downloaded firmware binary.</p>
<h4 id='3-execute-updates' class='heading'>3. Execute updates</h4>

<p>In this step, Jacquard sdk will install the firmware binary on the tag. You can skip this step by passing
<code>shouldAutoExecute=true</code> in Apply updates (Step 2).</p>

<p>The control for executing the installation is provided as a separate API, because the Tag will reboot after
installation, As a general practice, you should inform the users that this will happen.</p>

<p>Note: This step is not required in case of loadable module.</p>

<p>Let&rsquo;s start with the implementation. It&rsquo;s pretty much straight forward.</p>
<h4 id='update-tag-interposer-firmware' class='heading'>Update tag / interposer firmware</h4>

<p>##### 1. Check if update available -</p>

<p>To check if update is available for both tag and interposer, insert your tag into your gear and use below piece of
 code -</p>
<pre class="highlight swift"><code><span class="n">tag</span><span class="o">.</span><span class="n">firmwareUpdateManager</span><span class="o">.</span><span class="nf">checkUpdates</span><span class="p">(</span><span class="nv">forceCheck</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
  <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="n">completion</span> <span class="k">in</span>
    <span class="k">if</span> <span class="k">case</span> <span class="o">.</span><span class="nf">failure</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">)</span> <span class="o">=</span> <span class="n">completion</span> <span class="p">{</span>
      <span class="nf">print</span><span class="p">(</span><span class="s">"Firmware update error: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="nv">receiveValue</span><span class="p">:</span> <span class="p">{</span> <span class="n">updates</span> <span class="k">in</span>
    <span class="nf">print</span><span class="p">(</span><span class="s">"Available firmware updates: </span><span class="se">\(</span><span class="n">updates</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
  <span class="p">}</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observers</span><span class="p">)</span>
</code></pre>

<p>This code will return an array of <code><a href="Structs/DFUUpdateInfo.html">DFUUpdateInfo</a></code> for each input component. Check the value for
<code><a href="Structs/DFUUpdateInfo.html#/s:11JacquardSDK13DFUUpdateInfoV9dfuStatusAA0cdF0Ovp">DFUUpdateInfo.dfuStatus</a></code> to know what type of firmware update is available. It could be either
<code>mandatory</code> or <code>optional</code> or <code>none</code>. <code>forceCheck</code> boolean is used by the sdk to decide if data would be retrieved
from cloud or cached info should be returned.</p>

<p>It&rsquo;s advised to use <code>forceCheck</code> as <code>false</code>, because it allows SDK to decide the best source of information.</p>
<h5 id='2-apply-updates' class='heading'>2. Apply updates -</h5>

<p>Here, Jacquard sdk will transfer downloaded firmware binary from mobile to the tag. You need to use an array of
<code><a href="Structs/DFUUpdateInfo.html">DFUUpdateInfo</a></code> which you have received in previous step.</p>
<pre class="highlight swift"><code><span class="n">tag</span><span class="o">.</span><span class="n">firmwareUpdateManager</span><span class="o">.</span><span class="nf">applyUpdates</span><span class="p">(</span><span class="n">updates</span><span class="p">,</span> <span class="nv">shouldAutoExecute</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
  <span class="o">.</span><span class="n">sink</span> <span class="p">{</span> <span class="n">state</span> <span class="k">in</span>
    <span class="k">switch</span> <span class="n">state</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">idle</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">preparingForTransfer</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">transferring</span><span class="p">(</span><span class="k">let</span> <span class="nv">progress</span><span class="p">):</span>
      <span class="nf">print</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">transferred</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">executing</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">completed</span><span class="p">:</span> <span class="k">break</span>
    <span class="k">case</span> <span class="o">.</span><span class="nf">error</span><span class="p">(</span><span class="k">let</span> <span class="nv">error</span><span class="p">):</span>
      <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="o">.</span><span class="nf">addTo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">observers</span><span class="p">)</span>
</code></pre>

<p><code><a href="Enums/FirmwareUpdateState.html">FirmwareUpdateState</a></code> will give you the exact status of the operation. When Jacquard sdk
starts transferring firmware binary to the tag. i.e. state is <code>transferring</code>, you can track the
transfer progress using below code:</p>
<pre class="highlight swift"><code><span class="k">switch</span> <span class="n">state</span> <span class="p">{</span>
<span class="k">case</span> <span class="o">.</span><span class="nf">transferring</span><span class="p">(</span><span class="k">let</span> <span class="nv">progress</span><span class="p">):</span>
  <span class="nf">print</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>

<p>You can use <code>shouldAutoExecute=true</code> to install the updates automatically, otherwise you will need to call
<code>executeUpdates()</code> api explicitly after when state is changed to <code>transferred</code>.</p>

<p><code>FirwareUpdateState.error()</code> will give you the error occurred in this step.</p>
<h5 id='3-execute-updates' class='heading'>3. Execute updates -</h5>

<p>This is the last step in firmware update in which Jacquard sdk instructs tag to install the firmware
binary transferred in previous step. This step is not required if you are sending <code>shouldAutoExecute=true</code>
in <code>applyUpdates()</code> api. If you are updating tag firmware, tag will reboot during this step.</p>
<pre class="highlight swift"><code><span class="n">tag</span><span class="o">.</span><span class="n">firmwareUpdateManager</span><span class="o">.</span><span class="nf">executeUpdates</span><span class="p">()</span>
</code></pre>

<p><code><a href="Enums/FirmwareUpdateState.html">FirmwareUpdateState</a></code> returned by this api can either be <code>executing</code> or <code>completed</code>.</p>

<div class="footnotes">
<hr>
<ol>

<li><div class='footnote-def' id="fn2"><p>The eagle eyed may notice that it would be simpler to use the
default arguments. Unfortunately there is currently an issue with
the way the Swift binary <code>swiftinterface</code> file is generated for
Objective-C ABI classes that means
<code>JacquardManagerImplementation()</code> would compile but generate a
runtime exception. This will be fixed in the next
release. <a href="https://github.com/google/JacquardSDKiOS/issues/3">#3</a>.&nbsp;<a href="#fnref2">&#8617;</a></p>
</div></li>
<li><div class='footnote-def' id="fn3"><p>As always, in a real app try to avoid using the
<code>try!</code> force-try.&nbsp;<a href="#fnref3">&#8617;</a></p>
</div></li>
</ol>
</div>

          </div>
        </section>


      </article>
    </div>
    <section class="footer">
      <p>Copyright 2021-present LLC.</p>
      <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external noopener">jazzy ♪♫ v0.14.3</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external noopener">Realm</a> project.</p>
    </section>
  </body>
</html>
